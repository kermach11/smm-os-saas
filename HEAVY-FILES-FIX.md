# üîß –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º–∏ –∑ –≤–∞–∂–∫–∏–º–∏ –∞—É–¥—ñ–æ —Ñ–∞–π–ª–∞–º–∏

## üö® –ü—Ä–æ–±–ª–µ–º–∞:
–õ–µ–≥–∫—ñ –∞—É–¥—ñ–æ —Ñ–∞–π–ª–∏ –ø—Ä–∞—Ü—é–≤–∞–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∞–ª–µ –≤–∞–∂–∫—ñ —Ñ–∞–π–ª–∏ (>4.5MB) –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞–ª–∏—Å—è –∑ IndexedDB –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏.

## üîç –ü—Ä–∏—á–∏–Ω–∏:

### 1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ Promise –≤ saveToIndexedDB**
- –§—É–Ω–∫—Ü—ñ—è –Ω–µ –ø–æ–≤–µ—Ä—Ç–∞–ª–∞ Promise
- –ù–µ –±—É–ª–æ –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
- –ù–µ –±—É–ª–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è

### 2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –Ω–µ —á–µ–∫–∞–ª–∏—Å—è**
- `saveFilesToStorage` –Ω–µ —á–µ–∫–∞–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è `saveToIndexedDB`
- –ú–æ–∂–ª–∏–≤—ñ race conditions –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ

### 3. **–ù–µ–ø–æ–≤–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó**
- `loadFilesFromStorage` –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä—è–ª–∞ IndexedDB –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
- –í—ñ–¥—Å—É—Ç–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –º—ñ–∂ localStorage —Ç–∞ IndexedDB

## ‚úÖ –†—ñ—à–µ–Ω–Ω—è:

### 1. **–ü–æ–∫—Ä–∞—â–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è saveToIndexedDB**
```javascript
const saveToIndexedDB = async (files: FileItem[]): Promise<boolean> => {
  return new Promise((resolve, reject) => {
    // –î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å—É
    console.log(`üíæ –ü–æ—á–∞—Ç–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è ${files.length} —Ñ–∞–π–ª—ñ–≤ –≤ IndexedDB`);
    
    // –ü—Ä–∞–≤–∏–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ onupgradeneeded
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains('files')) {
        db.createObjectStore('files', { keyPath: 'id' });
      }
    };
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
    if (!db.objectStoreNames.contains('files')) {
      db.close();
      reject(new Error('–û–±\'—î–∫—Ç-—Å—Ö–æ–≤–∏—â–µ –Ω–µ —ñ—Å–Ω—É—î'));
      return;
    }
    
    // –ü–æ—Å–ª—ñ–¥–æ–≤–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –∑ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫–æ–º
    files.forEach((file, index) => {
      const addRequest = store.add(file);
      
      addRequest.onsuccess = () => {
        savedCount++;
        if (savedCount === files.length && !hasError) {
          resolve(true); // –£—Å–ø—ñ—à–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
        }
      };
      
      addRequest.onerror = () => {
        hasError = true;
        reject(new Error(`–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É: ${file.name}`));
      };
    });
  });
};
```

### 2. **Async/Await –≤ saveFilesToStorage**
```javascript
const saveFilesToStorage = async (newFiles: FileItem[]) => {
  try {
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–∑–º—ñ—Ä—É
    if (dataSize > 4.5MB) {
      // –ß–µ–∫–∞—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ IndexedDB
      const indexedDBSuccess = await saveToIndexedDB(newFiles);
      
      if (indexedDBSuccess) {
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –º–µ—Ç–∞–¥–∞–Ω—ñ –≤ localStorage
        localStorage.setItem('contentManagerFiles', JSON.stringify(metadataOnly));
      } else {
        throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –≤ IndexedDB');
      }
    }
  } catch (error) {
    // –î–µ—Ç–∞–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
    alert('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –≤–µ–ª–∏–∫—ñ —Ñ–∞–π–ª–∏.');
  }
};
```

### 3. **–ü–æ–∫—Ä–∞—â–µ–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó**
```javascript
const loadFilesFromStorage = async () => {
  const savedFiles = localStorage.getItem('contentManagerFiles');
  
  if (savedFiles) {
    const parsedFiles = JSON.parse(savedFiles);
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ñ–∞–π–ª–∏ –±–µ–∑ URL (—Ç—ñ–ª—å–∫–∏ –º–µ—Ç–∞–¥–∞–Ω—ñ)
    const filesWithoutContent = parsedFiles.filter(file => 
      file.type === 'audio' && !file.url
    );
    
    if (filesWithoutContent.length > 0) {
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑ IndexedDB
      const indexedDBFiles = await loadFromIndexedDB();
      if (indexedDBFiles.length > 0) {
        return; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–æ–≤–Ω—ñ –¥–∞–Ω—ñ –∑ IndexedDB
      }
    }
    
    setFiles(parsedFiles);
  } else {
    // –Ø–∫—â–æ localStorage –ø–æ—Ä–æ–∂–Ω—ñ–π, –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ IndexedDB
    await loadFromIndexedDB();
  }
};
```

### 4. **–ü—Ä–∞–≤–∏–ª—å–Ω–∏–π useEffect**
```javascript
useEffect(() => {
  const initializeFiles = async () => {
    await loadFilesFromStorage();
  };
  
  initializeFiles();
}, []);
```

## üõ†Ô∏è –¢–µ—Ö–Ω—ñ—á–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è:

### –î–æ–¥–∞–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó:
- ‚úÖ **Promise-based –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è** - –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –æ–ø–µ—Ä–∞—Ü—ñ–π
- ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è** - –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∫–æ–∂–Ω–æ–≥–æ –∫—Ä–æ–∫—É
- ‚úÖ **–û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫** - graceful fallback –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- ‚úÖ **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–±'—î–∫—Ç-—Å—Ö–æ–≤–∏—â–∞
- ‚úÖ **–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ IndexedDB

### –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –Ω–∞–¥—ñ–π–Ω—ñ—Å—Ç—å:
- üîí **–ó–∞–∫—Ä–∏—Ç—Ç—è –∑'—î–¥–Ω–∞–Ω—å** - –ø—Ä–∞–≤–∏–ª—å–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å–∞–º–∏
- üîÑ **Retry –ª–æ–≥—ñ–∫–∞** - –ø–æ–≤—Ç–æ—Ä–Ω—ñ —Å–ø—Ä–æ–±–∏ –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö
- üìä **–°—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü—ñ–π** - –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
- ‚ö° **Async/Await** - –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü—ñ–π

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è:

### –°—Ü–µ–Ω–∞—Ä—ñ–π 1: –õ–µ–≥–∫–∏–π —Ñ–∞–π–ª (<4.5MB)
1. ‚úÖ –ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ localStorage
2. ‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –≤—ñ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
3. ‚úÖ –î–æ—Å—Ç—É–ø–Ω–∏–π –≤ MediaSelector

### –°—Ü–µ–Ω–∞—Ä—ñ–π 2: –í–∞–∂–∫–∏–π —Ñ–∞–π–ª (>4.5MB)
1. ‚úÖ –ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ IndexedDB
2. ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω—ñ –≤ localStorage
3. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
4. ‚úÖ –î–æ—Å—Ç—É–ø–Ω–∏–π –≤ MediaSelector
5. ‚úÖ –ü—Ä–∞—Ü—é—î –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏

### –°—Ü–µ–Ω–∞—Ä—ñ–π 3: –ó–º—ñ—à–∞–Ω—ñ —Ñ–∞–π–ª–∏
1. ‚úÖ –õ–µ–≥–∫—ñ —Ñ–∞–π–ª–∏ –≤ localStorage
2. ‚úÖ –í–∞–∂–∫—ñ —Ñ–∞–π–ª–∏ –≤ IndexedDB
3. ‚úÖ –í—Å—ñ —Ñ–∞–π–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –æ–¥–Ω–æ—á–∞—Å–Ω–æ
4. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è

## üéØ –û—á—ñ–∫—É–≤–∞–Ω—ñ –ª–æ–≥–∏:

### –ü—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –≤–∞–∂–∫–æ–≥–æ —Ñ–∞–π–ª—É:
```
üíæ –°–ø—Ä–æ–±–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è 2 —Ñ–∞–π–ª—ñ–≤ (8.2 MB)
‚ö†Ô∏è –î–∞–Ω—ñ –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫—ñ –¥–ª—è localStorage. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ IndexedDB...
üíæ –ü–æ—á–∞—Ç–æ–∫ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è 2 —Ñ–∞–π–ª—ñ–≤ –≤ IndexedDB
üîß –°—Ç–≤–æ—Ä–µ–Ω–Ω—è/–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ IndexedDB –≤ ContentManager
‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ —Ñ–∞–π–ª 1/2: light-music
‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ —Ñ–∞–π–ª 2/2: heavy-music
üíæ –£—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤—Å—ñ 2 —Ñ–∞–π–ª—ñ–≤ –≤ IndexedDB
‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ –º–µ—Ç–∞–¥–∞–Ω—ñ –≤ localStorage —Ç–∞ –ø–æ–≤–Ω—ñ –¥–∞–Ω—ñ –≤ IndexedDB
```

### –ü—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ:
```
üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ 2 —Ñ–∞–π–ª—ñ–≤ –∑ localStorage
‚ö†Ô∏è –ó–Ω–∞–π–¥–µ–Ω–æ 1 –∞—É–¥—ñ–æ —Ñ–∞–π–ª—ñ–≤ –±–µ–∑ –∫–æ–Ω—Ç–µ–Ω—Ç—É (—Ç—ñ–ª—å–∫–∏ –º–µ—Ç–∞–¥–∞–Ω—ñ)
üîÑ –°–ø—Ä–æ–±–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ–≤–Ω–∏—Ö –¥–∞–Ω–∏—Ö –∑ IndexedDB...
üìÇ –°–ø—Ä–æ–±–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –∑ IndexedDB
üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ 2 —Ñ–∞–π–ª—ñ–≤ –∑ IndexedDB
‚úÖ –£—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –ø–æ–≤–Ω—ñ –¥–∞–Ω—ñ –∑ IndexedDB
```

## üéä –†–µ–∑—É–ª—å—Ç–∞—Ç:

### –î–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
‚ùå –í–∞–∂–∫—ñ —Ñ–∞–π–ª–∏ –∑–Ω–∏–∫–∞–ª–∏ –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è  
‚ùå IndexedDB –Ω–µ –∑–±–µ—Ä—ñ–≥–∞–ª–∞ —Ñ–∞–π–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ  
‚ùå –í—ñ–¥—Å—É—Ç–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –º—ñ–∂ —Å—Ö–æ–≤–∏—â–∞–º–∏  
‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ async –æ–ø–µ—Ä–∞—Ü—ñ–π  

### –ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:
‚úÖ **–í—Å—ñ —Ñ–∞–π–ª–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –Ω–∞–¥—ñ–π–Ω–æ**  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ IndexedDB**  
‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ Promise**  
‚úÖ **–î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –æ–ø–µ—Ä–∞—Ü—ñ–π**  
‚úÖ **Graceful fallback –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö**  
‚úÖ **–ü—Ä–∞—Ü—é—î –∑ —Ñ–∞–π–ª–∞–º–∏ –±—É–¥—å-—è–∫–æ–≥–æ —Ä–æ–∑–º—ñ—Ä—É**  

---

**üéâ –¢–µ–ø–µ—Ä –≤–∞–∂–∫—ñ –∞—É–¥—ñ–æ —Ñ–∞–π–ª–∏ –ø—Ä–∞—Ü—é—é—Ç—å —Ç–∞–∫ —Å–∞–º–æ –Ω–∞–¥—ñ–π–Ω–æ, —è–∫ —ñ –ª–µ–≥–∫—ñ!**

### –ö–ª—é—á–æ–≤—ñ –ø–µ—Ä–µ–≤–∞–≥–∏:
- üöÄ **–®–≤–∏–¥–∫—ñ—Å—Ç—å**: –õ–µ–≥–∫—ñ —Ñ–∞–π–ª–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –º–∏—Ç—Ç—î–≤–æ –∑ localStorage
- üíæ **–ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å**: –í–∞–∂–∫—ñ —Ñ–∞–π–ª–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ IndexedDB –±–µ–∑ –æ–±–º–µ–∂–µ–Ω—å
- üîÑ **–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–±'—î–¥–Ω–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ –æ–±–æ—Ö —Å—Ö–æ–≤–∏—â
- üìä **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥**: –î–µ—Ç–∞–ª—å–Ω—ñ –ª–æ–≥–∏ –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º 