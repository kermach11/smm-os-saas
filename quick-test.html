<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–≤–∏–¥–∫–∏–π —Ç–µ—Å—Ç –≤–∞–∂–∫–∏—Ö —Ñ–∞–π–ª—ñ–≤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –®–≤–∏–¥–∫–∏–π —Ç–µ—Å—Ç –≤–∞–∂–∫–∏—Ö —Ñ–∞–π–ª—ñ–≤</h1>
        
        <div>
            <button onclick="clearAll()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
            <button onclick="checkStorage()">üìä –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ö–æ–≤–∏—â–µ</button>
            <button onclick="testHeavyFile()">üéµ –¢–µ—Å—Ç –≤–∞–∂–∫–æ–≥–æ —Ñ–∞–π–ª—É</button>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearAll() {
            localStorage.removeItem('contentManagerFiles');
            const request = indexedDB.deleteDatabase('ContentManagerDB');
            request.onsuccess = () => {
                log('‚úÖ –í—Å–µ —Å—Ö–æ–≤–∏—â–µ –æ—á–∏—â–µ–Ω–æ');
                document.getElementById('log').innerHTML = '';
            };
            request.onerror = () => {
                log('‚ùå –ü–æ–º–∏–ª–∫–∞ –æ—á–∏—â–µ–Ω–Ω—è IndexedDB');
            };
        }

        function checkStorage() {
            log('üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ö–æ–≤–∏—â–∞...');
            
            // localStorage
            const localData = localStorage.getItem('contentManagerFiles');
            if (localData) {
                const files = JSON.parse(localData);
                log(`üìÇ localStorage: ${files.length} —Ñ–∞–π–ª—ñ–≤`);
                files.forEach((file, i) => {
                    log(`  ${i+1}. ${file.name} (${file.type}, URL: ${file.url ? '—î' : '–Ω–µ–º–∞—î'})`);
                });
            } else {
                log('üìÇ localStorage –ø–æ—Ä–æ–∂–Ω—ñ–π');
            }

            // IndexedDB
            const request = indexedDB.open('ContentManagerDB', 1);
            request.onsuccess = (event) => {
                const db = event.target.result;
                if (db.objectStoreNames.contains('files')) {
                    const transaction = db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const getAllRequest = store.getAll();
                    
                    getAllRequest.onsuccess = () => {
                        const files = getAllRequest.result;
                        log(`üíæ IndexedDB: ${files.length} —Ñ–∞–π–ª—ñ–≤`);
                        files.forEach((file, i) => {
                            log(`  ${i+1}. ${file.name} (${file.type}, ${(file.size/1024/1024).toFixed(2)} MB)`);
                        });
                        db.close();
                    };
                } else {
                    log('üíæ IndexedDB: –æ–±\'—î–∫—Ç-—Å—Ö–æ–≤–∏—â–µ –Ω–µ —ñ—Å–Ω—É—î');
                    db.close();
                }
            };
            request.onerror = () => {
                log('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è IndexedDB');
            };
        }

        function testHeavyFile() {
            log('üéµ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤–∞–∂–∫–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª—É...');
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ–µ–π–∫–æ–≤–∏–π –≤–∞–∂–∫–∏–π —Ñ–∞–π–ª (5MB)
            const size = 5 * 1024 * 1024; // 5MB
            const data = new Array(size).fill('a').join('');
            const base64 = btoa(data);
            const dataUrl = `data:audio/wav;base64,${base64}`;
            
            const heavyFile = {
                id: `test-heavy-${Date.now()}`,
                name: '–¢–µ—Å—Ç–æ–≤–∏–π –≤–∞–∂–∫–∏–π —Ñ–∞–π–ª',
                type: 'audio',
                url: dataUrl,
                originalName: 'test-heavy.wav',
                size: dataUrl.length,
                uploadDate: new Date().toISOString(),
                optimized: false
            };
            
            log(`‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ —Ñ–∞–π–ª: ${(heavyFile.size / 1024 / 1024).toFixed(2)} MB`);
            
            // –¢–µ—Å—Ç—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
            const files = [heavyFile];
            const dataToSave = JSON.stringify(files);
            const sizeInMB = (new Blob([dataToSave]).size / 1024 / 1024).toFixed(2);
            
            log(`üìä –†–æ–∑–º—ñ—Ä –¥–∞–Ω–∏—Ö –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ${sizeInMB} MB`);
            
            if (new Blob([dataToSave]).size > 4.5 * 1024 * 1024) {
                log('‚ö†Ô∏è –î–∞–Ω—ñ –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫—ñ –¥–ª—è localStorage, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ IndexedDB...');
                
                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ IndexedDB
                const request = indexedDB.open('ContentManagerDB', 1);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('files')) {
                        db.createObjectStore('files', { keyPath: 'id' });
                        log('‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ –æ–±\'—î–∫—Ç-—Å—Ö–æ–≤–∏—â–µ');
                    }
                };
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    const transaction = db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    
                    store.clear();
                    const addRequest = store.add(heavyFile);
                    
                    addRequest.onsuccess = () => {
                        log('‚úÖ –§–∞–π–ª –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ IndexedDB');
                        
                        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –º–µ—Ç–∞–¥–∞–Ω—ñ –≤ localStorage
                        const metadata = [{
                            ...heavyFile,
                            url: '' // –í–∏–¥–∞–ª—è—î–º–æ URL –¥–ª—è –∞—É–¥—ñ–æ
                        }];
                        localStorage.setItem('contentManagerFiles', JSON.stringify(metadata));
                        log('‚úÖ –ú–µ—Ç–∞–¥–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ localStorage');
                        
                        db.close();
                        
                        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        setTimeout(() => {
                            log('üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É...');
                            checkStorage();
                        }, 500);
                    };
                    
                    addRequest.onerror = () => {
                        log('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ IndexedDB');
                        db.close();
                    };
                };
                
                request.onerror = () => {
                    log('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è IndexedDB');
                };
            } else {
                localStorage.setItem('contentManagerFiles', dataToSave);
                log('‚úÖ –§–∞–π–ª –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ localStorage');
            }
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ –®–≤–∏–¥–∫–∏–π —Ç–µ—Å—Ç –≥–æ—Ç–æ–≤–∏–π');
        });
    </script>
</body>
</html> 