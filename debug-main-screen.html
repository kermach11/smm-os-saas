<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≥–æ–ª–æ–≤–Ω–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .button:hover { background: #0056b3; }
        #log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .status.warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≥–æ–ª–æ–≤–Ω–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏</h1>
        
        <div>
            <button class="button" onclick="testMainScreenLogic()">–¢–µ—Å—Ç—É–≤–∞—Ç–∏ –ª–æ–≥—ñ–∫—É MainScreen</button>
            <button class="button" onclick="fixAndTestMusic()">–í–∏–ø—Ä–∞–≤–∏—Ç–∏ —ñ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –º—É–∑–∏–∫—É</button>
            <button class="button" onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç–∏ –ª–æ–≥</button>
        </div>

        <div id="results"></div>
        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logDiv.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`${prefix} ${message}`);
        }

        function showStatus(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
            resultsDiv.appendChild(statusDiv);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('results').innerHTML = '';
        }

        async function testMainScreenLogic() {
            log('üîç –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ª–æ–≥—ñ–∫–∏ MainScreen...');
            
            try {
                // –ö—Ä–æ–∫ 1: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
                const mainPageData = localStorage.getItem('mainPageSettings');
                if (!mainPageData) {
                    log('‚ùå mainPageSettings –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                    return;
                }
                
                const settings = JSON.parse(mainPageData);
                log('‚úÖ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ', 'success');
                
                // –ö—Ä–æ–∫ 2: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞—É–¥—ñ–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
                if (!settings.audioSettings) {
                    log('‚ùå audioSettings –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                    return;
                }
                
                const audioSettings = settings.audioSettings;
                log('üìÇ –ê—É–¥—ñ–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–Ω–∞–π–¥–µ–Ω–æ:', 'success');
                log(`  - backgroundMusic.enabled: ${audioSettings.backgroundMusic?.enabled}`, 'info');
                log(`  - backgroundMusic.url: ${audioSettings.backgroundMusic?.url ? '—î' : '–Ω–µ–º–∞—î'}`, 'info');
                
                // –ö—Ä–æ–∫ 3: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É–º–æ–≤–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
                const needsHeavyAudioLoad = (
                    (audioSettings.backgroundMusic?.enabled && !audioSettings.backgroundMusic?.url) ||
                    (audioSettings.hoverSounds?.enabled && !audioSettings.hoverSounds?.url) ||
                    (audioSettings.clickSounds?.enabled && !audioSettings.clickSounds?.url)
                );
                
                log(`üîç –ü–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤–∞–∂–∫—ñ –∞—É–¥—ñ–æ —Ñ–∞–π–ª–∏: ${needsHeavyAudioLoad}`, needsHeavyAudioLoad ? 'warning' : 'info');
                
                if (!needsHeavyAudioLoad) {
                    log('‚ÑπÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ - –ª–æ–≥—ñ–∫–∞ –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è —Ç—É—Ç', 'info');
                    showStatus('–õ–æ–≥—ñ–∫–∞ MainScreen –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è - –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ', 'warning');
                    return;
                }
                
                // –ö—Ä–æ–∫ 4: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ ContentManager —Ñ–∞–π–ª—ñ–≤
                const contentManagerFiles = localStorage.getItem('contentManagerFiles');
                if (!contentManagerFiles) {
                    log('‚ùå contentManagerFiles –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                    return;
                }
                
                const files = JSON.parse(contentManagerFiles);
                const heavyAudioFiles = files.filter(file => 
                    file.type === 'audio' && !file.url && file.size > 2 * 1024 * 1024
                );
                
                log(`üìÇ –í–∞–∂–∫–∏—Ö –∞—É–¥—ñ–æ —Ñ–∞–π–ª—ñ–≤ –±–µ–∑ URL: ${heavyAudioFiles.length}`, 'info');
                
                if (heavyAudioFiles.length === 0) {
                    log('‚ÑπÔ∏è –í–∞–∂–∫–∏—Ö —Ñ–∞–π–ª—ñ–≤ –Ω–µ–º–∞—î - –ª–æ–≥—ñ–∫–∞ –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è —Ç—É—Ç', 'info');
                    showStatus('–õ–æ–≥—ñ–∫–∞ MainScreen –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è - –≤–∞–∂–∫–∏—Ö —Ñ–∞–π–ª—ñ–≤ –Ω–µ–º–∞—î', 'warning');
                    return;
                }
                
                // –ö—Ä–æ–∫ 5: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è IndexedDB
                log('üîÑ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ IndexedDB...', 'info');
                const result = await testIndexedDBLoad(audioSettings);
                
                if (result) {
                    log('‚úÖ –õ–æ–≥—ñ–∫–∞ MainScreen –ø—Ä–∞—Ü—é—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ!', 'success');
                    showStatus('‚úÖ –õ–æ–≥—ñ–∫–∞ MainScreen –ø—Ä–∞—Ü—é—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ!', 'success');
                } else {
                    log('‚ùå –ü—Ä–æ–±–ª–µ–º–∞ –≤ –ª–æ–≥—ñ—Ü—ñ IndexedDB', 'error');
                    showStatus('‚ùå –ü—Ä–æ–±–ª–µ–º–∞ –≤ –ª–æ–≥—ñ—Ü—ñ IndexedDB', 'error');
                }
                
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è: ${error.message}`, 'error');
                showStatus(`‚ùå –ü–æ–º–∏–ª–∫–∞ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è: ${error.message}`, 'error');
            }
        }

        async function testIndexedDBLoad(audioSettings) {
            return new Promise((resolve) => {
                const request = indexedDB.open('ContentManagerDB', 2);
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('files')) {
                        log('‚ùå –û–±\'—î–∫—Ç-—Å—Ö–æ–≤–∏—â–µ "files" –Ω–µ —ñ—Å–Ω—É—î', 'error');
                        db.close();
                        resolve(false);
                        return;
                    }
                    
                    const transaction = db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const getAllRequest = store.getAll();
                    
                    getAllRequest.onsuccess = () => {
                        const indexedDBFiles = getAllRequest.result;
                        log(`üìÇ –§–∞–π–ª—ñ–≤ –≤ IndexedDB: ${indexedDBFiles.length}`, 'info');
                        
                        const audioFiles = indexedDBFiles.filter(file => file.type === 'audio');
                        log(`üéµ –ê—É–¥—ñ–æ —Ñ–∞–π–ª—ñ–≤ –≤ IndexedDB: ${audioFiles.length}`, 'info');
                        
                        audioFiles.forEach((file, index) => {
                            log(`  ${index + 1}. ${file.name} (${file.url ? '–º–∞—î URL' : '–±–µ–∑ URL'})`, 'info');
                        });
                        
                        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –º–æ–∂–µ–º–æ –∑–Ω–∞–π—Ç–∏ —Ñ–∞–π–ª –¥–ª—è —Ñ–æ–Ω–æ–≤–æ—ó –º—É–∑–∏–∫–∏
                        if (audioSettings.backgroundMusic?.enabled && !audioSettings.backgroundMusic?.url) {
                            const backgroundMusicFile = indexedDBFiles.find(file => 
                                file.type === 'audio' && file.url
                            );
                            
                            if (backgroundMusicFile) {
                                log(`‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª –¥–ª—è —Ñ–æ–Ω–æ–≤–æ—ó –º—É–∑–∏–∫–∏: ${backgroundMusicFile.name}`, 'success');
                                resolve(true);
                            } else {
                                log('‚ùå –§–∞–π–ª –¥–ª—è —Ñ–æ–Ω–æ–≤–æ—ó –º—É–∑–∏–∫–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                                resolve(false);
                            }
                        } else {
                            log('‚ÑπÔ∏è –§–æ–Ω–æ–≤–∞ –º—É–∑–∏–∫–∞ –Ω–µ –ø–æ—Ç—Ä–µ–±—É—î –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è', 'info');
                            resolve(true);
                        }
                        
                        db.close();
                    };
                    
                    getAllRequest.onerror = () => {
                        log('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –∑ IndexedDB', 'error');
                        db.close();
                        resolve(false);
                    };
                };
                
                request.onerror = () => {
                    log('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è IndexedDB', 'error');
                    resolve(false);
                };
            });
        }

        async function fixAndTestMusic() {
            log('üîß –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —ñ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –º—É–∑–∏–∫–∏...');
            
            try {
                // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
                const mainPageData = localStorage.getItem('mainPageSettings');
                if (!mainPageData) {
                    log('‚ùå –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ', 'error');
                    return;
                }
                
                const settings = JSON.parse(mainPageData);
                
                // –Ø–∫—â–æ —Ñ–æ–Ω–æ–≤–∞ –º—É–∑–∏–∫–∞ —É–≤—ñ–º–∫–Ω–µ–Ω–∞ –∞–ª–µ –Ω–µ–º–∞—î URL
                if (settings.audioSettings?.backgroundMusic?.enabled && !settings.audioSettings.backgroundMusic.url) {
                    log('üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –º—É–∑–∏–∫—É –∑ IndexedDB...', 'info');
                    
                    const musicUrl = await loadMusicFromIndexedDB();
                    if (musicUrl) {
                        // –û–Ω–æ–≤–ª—é—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
                        settings.audioSettings.backgroundMusic.url = musicUrl;
                        localStorage.setItem('mainPageSettings', JSON.stringify(settings));
                        
                        log('‚úÖ URL –º—É–∑–∏–∫–∏ –æ–Ω–æ–≤–ª–µ–Ω–æ –≤ localStorage', 'success');
                        
                        // –¢–µ—Å—Ç—É—î–º–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
                        const audio = new Audio(musicUrl);
                        audio.volume = 0.1;
                        
                        try {
                            await audio.play();
                            log('‚úÖ –ú—É–∑–∏–∫–∞ –≤—ñ–¥—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —É—Å–ø—ñ—à–Ω–æ!', 'success');
                            showStatus('‚úÖ –ú—É–∑–∏–∫–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∞ —ñ –ø—Ä–∞—Ü—é—î!', 'success');
                            
                            setTimeout(() => {
                                audio.pause();
                                log('‚èπÔ∏è –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ', 'info');
                            }, 3000);
                        } catch (error) {
                            log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è: ${error.message}`, 'error');
                        }
                    } else {
                        log('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º—É–∑–∏–∫—É –∑ IndexedDB', 'error');
                        showStatus('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º—É–∑–∏–∫—É –∑ IndexedDB', 'error');
                    }
                } else {
                    log('‚ÑπÔ∏è –ú—É–∑–∏–∫–∞ –≤–∂–µ –º–∞—î URL –∞–±–æ –≤–∏–º–∫–Ω–µ–Ω–∞', 'info');
                    showStatus('‚ÑπÔ∏è –ú—É–∑–∏–∫–∞ –≤–∂–µ –º–∞—î URL –∞–±–æ –≤–∏–º–∫–Ω–µ–Ω–∞', 'info');
                }
                
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è: ${error.message}`, 'error');
                showStatus(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è: ${error.message}`, 'error');
            }
        }

        async function loadMusicFromIndexedDB() {
            return new Promise((resolve) => {
                const request = indexedDB.open('ContentManagerDB', 2);
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('files')) {
                        log('‚ùå –û–±\'—î–∫—Ç-—Å—Ö–æ–≤–∏—â–µ "files" –Ω–µ —ñ—Å–Ω—É—î', 'error');
                        db.close();
                        resolve(null);
                        return;
                    }
                    
                    const transaction = db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const getAllRequest = store.getAll();
                    
                    getAllRequest.onsuccess = () => {
                        const files = getAllRequest.result;
                        const audioFile = files.find(file => file.type === 'audio' && file.url);
                        
                        if (audioFile) {
                            log(`‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ –∞—É–¥—ñ–æ —Ñ–∞–π–ª: ${audioFile.name}`, 'success');
                            resolve(audioFile.url);
                        } else {
                            log('‚ùå –ê—É–¥—ñ–æ —Ñ–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ IndexedDB', 'error');
                            resolve(null);
                        }
                        
                        db.close();
                    };
                    
                    getAllRequest.onerror = () => {
                        log('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –∑ IndexedDB', 'error');
                        db.close();
                        resolve(null);
                    };
                };
                
                request.onerror = () => {
                    log('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è IndexedDB', 'error');
                    resolve(null);
                };
            });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –∑–∞–ø—É—Å–∫
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≥–æ—Ç–æ–≤–∞');
            showStatus('–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–¢–µ—Å—Ç—É–≤–∞—Ç–∏ –ª–æ–≥—ñ–∫—É MainScreen" –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏', 'info');
        });
    </script>
</body>
</html> 